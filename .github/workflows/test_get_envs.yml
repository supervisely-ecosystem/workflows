name: Test Get Envs Script

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: "Test scenario to run"
        required: true
        type: choice
        options:
          - "all_scenarios"
          - "specific_vars"
          - "prefix_filter"
          - "multiline_values"
          - "secrets_handling"
        default: "all_scenarios"

jobs:
  test-get-envs:
    runs-on: gha-runner-supervisely-ecosystem

    env:
      # Test variables
      TEST_VAR_1: "simple_value"
      TEST_VAR_2: "value with spaces"
      TEST_SECRET_KEY: "secret_value_123"
      MY_APP_HOST: "localhost"
      MY_APP_PORT: "8080"
      MY_APP_DEBUG: "true"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display initial GITHUB_ENV content
        run: |
          echo "=== Initial GITHUB_ENV ==="
          if [ -f "$GITHUB_ENV" ]; then
            cat "$GITHUB_ENV" || echo "(empty)"
          else
            echo "GITHUB_ENV file does not exist"
          fi
          echo ""

      - name: Check CONTAINER_REGISTRY_INTERNAL before extraction
        run: |
          echo "=== Checking CONTAINER_REGISTRY_INTERNAL before extraction ==="
          if [ -z "$CONTAINER_REGISTRY_INTERNAL" ]; then
            echo "✓ CONTAINER_REGISTRY_INTERNAL is NOT set (as expected)"
          else
            echo "✗ CONTAINER_REGISTRY_INTERNAL is set to: $CONTAINER_REGISTRY_INTERNAL"
          fi
          echo ""

      - name: Display all available environment variables (masked)
        run: |
          echo "=== Available environment variables ==="
          env | sort | head -20
          echo "... (showing first 20)"
          echo ""

      # Scenario 1: Export specific variables
      - name: "Scenario 1: Export specific variables"
        if: github.event.inputs.test_scenario == 'all_scenarios' || github.event.inputs.test_scenario == 'specific_vars'
        run: |
          echo "=== Scenario 1: Export specific variables ==="
          python3 get_envs.py --vars TEST_VAR_1 TEST_VAR_2 GITHUB_REPOSITORY
          echo ""

      - name: "Verify Scenario 1"
        if: github.event.inputs.test_scenario == 'all_scenarios' || github.event.inputs.test_scenario == 'specific_vars'
        run: |
          echo "=== Verifying exported variables ==="
          echo "TEST_VAR_1=$TEST_VAR_1"
          echo "TEST_VAR_2=$TEST_VAR_2"
          echo "GITHUB_REPOSITORY=$GITHUB_REPOSITORY"
          echo ""

      # Scenario 2: Export variables with prefix
      - name: "Scenario 2: Export variables with prefix MY_APP_"
        if: github.event.inputs.test_scenario == 'all_scenarios' || github.event.inputs.test_scenario == 'prefix_filter'
        run: |
          echo "=== Scenario 2: Export variables with prefix ==="
          python3 get_envs.py --prefix MY_APP_
          echo ""

      - name: "Verify Scenario 2"
        if: github.event.inputs.test_scenario == 'all_scenarios' || github.event.inputs.test_scenario == 'prefix_filter'
        run: |
          echo "=== Verifying prefix-filtered variables ==="
          echo "MY_APP_HOST=$MY_APP_HOST"
          echo "MY_APP_PORT=$MY_APP_PORT"
          echo "MY_APP_DEBUG=$MY_APP_DEBUG"
          echo ""

      # Scenario 3: Test multiline values
      - name: "Scenario 3: Create and export multiline variable"
        if: github.event.inputs.test_scenario == 'all_scenarios' || github.event.inputs.test_scenario == 'multiline_values'
        run: |
          echo "=== Scenario 3: Multiline values ==="
          # Create multiline variable
          echo "MULTILINE_VAR<<EOF" >> $GITHUB_ENV
          echo "Line 1" >> $GITHUB_ENV
          echo "Line 2 with special chars: %,$,!" >> $GITHUB_ENV
          echo "Line 3" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: "Export multiline variable"
        if: github.event.inputs.test_scenario == 'all_scenarios' || github.event.inputs.test_scenario == 'multiline_values'
        run: |
          python3 get_envs.py --vars MULTILINE_VAR
          echo ""

      - name: "Verify Scenario 3"
        if: github.event.inputs.test_scenario == 'all_scenarios' || github.event.inputs.test_scenario == 'multiline_values'
        run: |
          echo "=== Verifying multiline variable ==="
          echo "MULTILINE_VAR:"
          echo "$MULTILINE_VAR"
          echo ""

      # Scenario 4: Test secrets masking
      - name: "Scenario 4: Secrets handling and masking"
        if: github.event.inputs.test_scenario == 'all_scenarios' || github.event.inputs.test_scenario == 'secrets_handling'
        run: |
          echo "=== Scenario 4: Secrets handling ==="
          echo "Exporting variables with secret-like names..."
          python3 get_envs.py --vars TEST_SECRET_KEY
          echo ""

      - name: "Verify Scenario 4"
        if: github.event.inputs.test_scenario == 'all_scenarios' || github.event.inputs.test_scenario == 'secrets_handling'
        run: |
          echo "=== Verifying secret variable (should be available but not shown) ==="
          if [ -n "$TEST_SECRET_KEY" ]; then
            echo "✓ TEST_SECRET_KEY is set (value is masked in logs)"
          else
            echo "✗ TEST_SECRET_KEY is NOT set"
          fi
          echo ""

      # Scenario 5: CONTAINER_REGISTRY_INTERNAL test
      - name: "Scenario 5: Test CONTAINER_REGISTRY_INTERNAL extraction"
        if: github.event.inputs.test_scenario == 'all_scenarios'
        run: |
          echo "=== Scenario 5: CONTAINER_REGISTRY_INTERNAL ==="
          echo "Attempting to extract CONTAINER_REGISTRY_INTERNAL from runner..."
          python3 get_envs.py --vars CONTAINER_REGISTRY_INTERNAL || echo "Variable not found in runner environment"
          echo ""

      - name: "Verify CONTAINER_REGISTRY_INTERNAL in GITHUB_ENV"
        if: github.event.inputs.test_scenario == 'all_scenarios'
        run: |
          echo "=== Checking if CONTAINER_REGISTRY_INTERNAL is in GITHUB_ENV ==="
          if grep -q "CONTAINER_REGISTRY_INTERNAL" "$GITHUB_ENV"; then
            echo "✓ CONTAINER_REGISTRY_INTERNAL found in GITHUB_ENV:"
            grep "CONTAINER_REGISTRY_INTERNAL" "$GITHUB_ENV"
          else
            echo "✗ CONTAINER_REGISTRY_INTERNAL not found in GITHUB_ENV"
          fi
          echo ""

      - name: "Check CONTAINER_REGISTRY_INTERNAL after extraction"
        if: github.event.inputs.test_scenario == 'all_scenarios'
        run: |
          echo "=== Final check of CONTAINER_REGISTRY_INTERNAL ==="
          if [ -n "$CONTAINER_REGISTRY_INTERNAL" ]; then
            echo "✓ CONTAINER_REGISTRY_INTERNAL is now set to: $CONTAINER_REGISTRY_INTERNAL"
          else
            echo "✗ CONTAINER_REGISTRY_INTERNAL is still not set"
            echo "This is expected if the runner doesn't have this variable"
          fi
          echo ""

      # Exclude GitHub variables test
      - name: "Test excluding GitHub variables"
        run: |
          echo "=== Testing --exclude-github flag ==="
          python3 get_envs.py --prefix GITHUB_ --exclude-github
          echo "Should show no variables ^^"
          echo ""

      - name: Display final GITHUB_ENV content
        if: always()
        run: |
          echo "=== Final GITHUB_ENV content ==="
          if [ -f "$GITHUB_ENV" ]; then
            echo "File size: $(wc -c < "$GITHUB_ENV") bytes"
            echo "Line count: $(wc -l < "$GITHUB_ENV") lines"
            echo ""
            echo "Content preview (first 50 lines):"
            head -50 "$GITHUB_ENV"
          else
            echo "GITHUB_ENV file does not exist"
          fi
          echo ""

      - name: Summary
        if: always()
        run: |
          echo "=== Test Summary ==="
          echo "✓ All test scenarios completed"
          echo "Check the logs above for detailed results"
          echo ""
          echo "Key points:"
          echo "- Script can export specific variables"
          echo "- Prefix filtering works correctly"
          echo "- Multiline values are handled properly"
          echo "- Secrets are masked in output"
          echo "- Variables are correctly written to GITHUB_ENV"

  test-with-vars:
    runs-on: gha-runner-supervisely-ecosystem
    name: Test with repository variables

    # This job tests with actual repository variables and secrets
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test extracting GitHub context variables
        run: |
          echo "=== Testing GitHub context variables ==="
          python3 get_envs.py --prefix GITHUB_ --dry-run | head -30
          echo ""

      - name: Export common CI variables
        run: |
          echo "=== Exporting common CI variables ==="
          python3 get_envs.py --vars \
            GITHUB_REPOSITORY \
            GITHUB_REF \
            GITHUB_SHA \
            GITHUB_ACTOR \
            RUNNER_OS \
            RUNNER_ARCH

      - name: Verify exported variables are available
        run: |
          echo "=== Verifying exported variables ==="
          echo "GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "GITHUB_REF: $GITHUB_REF"
          echo "GITHUB_SHA: ${GITHUB_SHA:0:7}"
          echo "GITHUB_ACTOR: $GITHUB_ACTOR"
          echo "RUNNER_OS: $RUNNER_OS"
          echo "RUNNER_ARCH: $RUNNER_ARCH"
