name: Supervisely release
run-name: Supervisely ${{ github.repository }} app release
on:
  workflow_call:
    inputs:
      SUPERVISELY_SERVER_ADDRESS:
        required: true
        type: string
      SUPERVISELY_PROD_SERVER_ADDRESS:
        required: true
        type: string
      SLUG:
        required: true
        type: string
      RELEASE_VERSION:
        required: true
        type: string
      RELEASE_DESCRIPTION:
        required: true
        type: string
      SUBAPP_PATHS:
        required: true
        type: string
      RELEASE_TYPE:
        required: true
        type: string
      SKIP_INSTANCE_VERSION_VALIDATION:
        required: false
        type: boolean
        default: false
      SKIP_IMAGE_VALIDATION:
        required: false
        type: boolean
        default: false
      ARCHIVE_ONLY_CONFIG:
        required: false
        type: boolean
        default: false
      COMMIT_SHA:
        required: false
        type: string
        default: ""
      MODELS_PATH:
        required: false
        type: string
        default: ""
      FRAMEWORK:
        required: false
        type: string
        default: ""
      RELEASE_MODELS:
        required: false
        type: boolean
        default: false
    secrets:
      SUPERVISELY_DEV_API_TOKEN:
        required: true
      SUPERVISELY_PRIVATE_DEV_API_TOKEN:
        required: true
      SUPERVISELY_PROD_API_TOKEN:
        required: true
      GH_ACCESS_TOKEN:
        required: true

jobs:
  prepare:
    name: Prepare env outputs
    runs-on: gha-runner-supervisely-ecosystem
    outputs:
      dev_token: ${{ steps.gather.outputs.dev_token }}
      private_dev_token: ${{ steps.gather.outputs.private_dev_token }}
      prod_token: ${{ steps.gather.outputs.prod_token }}
      prod_address: ${{ steps.gather.outputs.prod_address }}
    steps:
      - name: Gather runner env
        id: gather
        shell: bash
        run: |
          # ensure we don't print secrets to logs
          set +x
          printf '%s=%s\n' "dev_token" "$SUPERVISELY_DEV_API_TOKEN" >> "$GITHUB_OUTPUT"
          printf '%s=%s\n' "private_dev_token" "$SUPERVISELY_PRIVATE_DEV_API_TOKEN" >> "$GITHUB_OUTPUT"
          printf '%s=%s\n' "prod_token" "$SUPERVISELY_PROD_API_TOKEN" >> "$GITHUB_OUTPUT"
          printf '%s=%s\n' "prod_address" "$SUPERVISELY_PROD_SERVER_ADDRESS" >> "$GITHUB_OUTPUT"

  Supervisely-Release:
    needs: prepare
    runs-on: gha-runner-supervisely-ecosystem
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.COMMIT_SHA }}
          fetch-depth: 0
      - uses: actions/checkout@v6
        with:
          repository: supervisely-ecosystem/workflows
          path: workflow

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1 libmagic1 skopeo
          python -m venv venv
          . venv/bin/activate
          python -m pip install --upgrade pip
          pip install -r ./workflow/requirements.txt
      - name: Supervisely Release
        run: |
          . venv/bin/activate
          python ./workflow/release.py
        env:
          DEV_SERVER_ADDRESS: "${{ inputs.SUPERVISELY_SERVER_ADDRESS }}"
          PROD_SERVER_ADDRESS: "${{ inputs.SUPERVISELY_PROD_SERVER_ADDRESS }}"
          DEV_API_TOKEN: "${{ needs.prepare.dev_token }}"
          PRIVATE_DEV_API_TOKEN: "${{ needs.prepare.private_dev_token }}"
          PROD_API_TOKEN: "${{ needs.prepare.prod_token }}"
          GH_ACCESS_TOKEN: "${{ env.SUPERVISELY_GITHUB_ACCESS_TOKEN }}"
          SLUG: "${{ inputs.SLUG }}"
          RELEASE_VERSION: "${{ inputs.RELEASE_VERSION }}"
          RELEASE_DESCRIPTION: "${{ inputs.RELEASE_DESCRIPTION }}"
          RELEASE_TYPE: "${{ inputs.RELEASE_TYPE }}"
          SUBAPP_PATHS: "${{ inputs.SUBAPP_PATHS }}"
          SKIP_INSTANCE_VERSION_VALIDATION: "${{ inputs.SKIP_INSTANCE_VERSION_VALIDATION }}"
          SKIP_IMAGE_VALIDATION: "${{ inputs.SKIP_IMAGE_VALIDATION }}"
          ARCHIVE_ONLY_CONFIG: "${{ inputs.ARCHIVE_ONLY_CONFIG }}"

  Models-release:
    needs:
      - Supervisely-Release
      - prepare
    if: inputs.RELEASE_MODELS && inputs.RELEASE_TYPE != 'release-branch'
    uses: supervisely-ecosystem/workflows/.github/workflows/sync_models_common.yml@vars-envs
    secrets:
      API_TOKEN: "${{ needs.prepare.prod_token }}"
    with:
      SERVER_ADDRESS: "${{ needs.prepare.prod_address }}"
      MODELS_PATH: "${{ inputs.MODELS_PATH }}"
      FRAMEWORK: "${{ inputs.FRAMEWORK }}"
